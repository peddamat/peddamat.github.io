<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="The last article in a series on DLLs, where we learn about the importance of RTFM, discuss subclassing pitfalls, how to debug DLLS, and end things on a high note by writing a production-ready DLL injector." name=description><meta content="Sumanth " name=author peddamatham&quot; sam&quot;><link href=https://samrambles.com/coding/production-ready-dll-injection/index.html rel=canonical><link href=../injecting-dlls-with-rust/index.html rel=prev><link href=../../dotfiles/index.html rel=next><link href=../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.4.2, mkdocs-material-9.0.15" name=generator><title>Production Ready DLL Injection - Sam Rambles</title><link href=../../assets/stylesheets/main.113286f1.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.a0c5b2b5.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CIMB+Plex+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Noto Sans";--md-code-font:"IMB Plex Mono"}</style><link href=../../assets/stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-RZQGZXT3GC"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RZQGZXT3GC');
</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent=white data-md-color-primary=white data-md-color-scheme=white dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#production-ready-dll-injection> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Sam Rambles" class="md-header__button md-logo" data-md-component=logo href=../../index.html title="Sam Rambles"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Sam Rambles </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Production Ready DLL Injection </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent=white data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary=white data-md-color-scheme=white id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent=black data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary=black data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <a aria-label=Share class="md-search__icon md-icon" data-clipboard data-clipboard-text data-md-component=search-share href=javascript:void(0) tabindex=-1 title=Share> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"></path></svg> </a> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/peddamat/mkdocs-obsidian title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> peddamat/mkdocs-obsidian </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav aria-label=Tabs class=md-tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a class=md-tabs__link href=../../index.html> Home </a> </li> <li class=md-tabs__item> <a class=md-tabs__link href=../../tags/index.html> Tags </a> </li> <li class=md-tabs__item> <a class="md-tabs__link md-tabs__link--active" href=../index.html> Coding </a> </li> <li class=md-tabs__item> <a class=md-tabs__link href=../../dotfiles/index.html> Dotfiles </a> </li> <li class=md-tabs__item> <a class=md-tabs__link href=../../fyi/index.html> FYI </a> </li> <li class=md-tabs__item> <a class=md-tabs__link href=../../lab-notes/index.html> Lab Notes </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary md-nav--lifted" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Sam Rambles" class="md-nav__button md-logo" data-md-component=logo href=../../index.html title="Sam Rambles"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg> </a> Sam Rambles </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/peddamat/mkdocs-obsidian title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> peddamat/mkdocs-obsidian </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../../index.html> Home </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../../tags/index.html> Tags </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" id=__nav_3 type=checkbox> <div class="md-nav__link md-nav__link--index"> <a href=../index.html>Coding</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-expanded=true aria-labelledby=__nav_3_label class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../creating-a-dll-with-rust/index.html> Creating A DLL With Rust </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../creating-a-window-with-rust/index.html> Creating A Window With Rust </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../debugging-a-mkdocs-plugin/index.html> Setting Up A MkDocs Plugin Development Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../injecting-dlls-with-rust/index.html> Injecting DLLs With Rust </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Production Ready DLL Injection <span class="md-nav__icon md-icon"></span> </label> <a class="md-nav__link md-nav__link--active" href=index.html> Production Ready DLL Injection </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#read-the-fscking-manual> Read The Fscking Manual </a> <nav aria-label="Read The Fscking Manual" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#setwindowlongptr> SetWindowLongPtr </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#conclusions> Conclusions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#further-reading> Further reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowsubclass> SetWindowSubclass </a> <nav aria-label=SetWindowSubclass class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#refactoring-create_windowexe> Refactoring create_window.exe </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#refactoring-hellodll> Refactoring hello.dll </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#hello_inject> hello_inject </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#further-reading_1> Further Reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#debugging> Debugging </a> <nav aria-label=Debugging class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#logging> Logging </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#tracing> Tracing </a> <nav aria-label=Tracing class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#process-monitor> Process Monitor </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowsubclass-cont> SetWindowSubclass (cont.) </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowshookex> SetWindowsHookEx </a> <nav aria-label=SetWindowsHookEx class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#further-reading_2> Further Reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#createthread> CreateThread </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#production-readiness> Production Readiness </a> <nav aria-label="Production Readiness" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#error-handling> Error Handling </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_4 type=checkbox> <div class="md-nav__link md-nav__link--index"> <a href=../../dotfiles/index.html>Dotfiles</a> <label for=__nav_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-expanded=false aria-labelledby=__nav_4_label class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Dotfiles </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../../dotfiles/how-i-setup-this-blog/index.html> How I Setup This Blog </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../../dotfiles/how-to-quickly-setup-a-wireless-mitm-proxy/index.html> How To Quickly Setup A Wireless MitM Proxy </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_4_4 type=checkbox> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> Embedded <span class="md-nav__icon md-icon"></span> </label> <nav aria-expanded=false aria-labelledby=__nav_4_4_label class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Embedded </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_4_4_1 type=checkbox> <label class=md-nav__link for=__nav_4_4_1 id=__nav_4_4_1_label tabindex=0> Stm32 <span class="md-nav__icon md-icon"></span> </label> <nav aria-expanded=false aria-labelledby=__nav_4_4_1_label class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_4_4_1> <span class="md-nav__icon md-icon"></span> Stm32 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../../dotfiles/embedded/stm32/itead-maple/index.html> ITead Maple </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_5 type=checkbox> <div class="md-nav__link md-nav__link--index"> <a href=../../fyi/index.html>FYI</a> <label for=__nav_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-expanded=false aria-labelledby=__nav_5_label class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> FYI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../../fyi/modern-debugging-tools-for-windows/index.html> Modern Debugging Tools For Windows </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../../fyi/using-chatgpt-to-generate-regexs/index.html> Using ChatGPT To Generate RegExs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_6 type=checkbox> <div class="md-nav__link md-nav__link--index"> <a href=../../lab-notes/index.html>Lab Notes</a> <label for=__nav_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-expanded=false aria-labelledby=__nav_6_label class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Lab Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" id=__nav_6_2 type=checkbox> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> Hunter Hacking <span class="md-nav__icon md-icon"></span> </label> <nav aria-expanded=false aria-labelledby=__nav_6_2_label class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> Hunter Hacking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../../lab-notes/hunter-hacking/atwinc1500-firmware-extraction-and-analysis/index.html> ATWINC1500 Firmware Extraction And Analysis </a> </li> <li class=md-nav__item> <a class=md-nav__link href=../../lab-notes/hunter-hacking/hunter-pro-hc-teardown/index.html> Hunter Pro-HC Teardown </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#read-the-fscking-manual> Read The Fscking Manual </a> <nav aria-label="Read The Fscking Manual" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#setwindowlongptr> SetWindowLongPtr </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#conclusions> Conclusions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#further-reading> Further reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowsubclass> SetWindowSubclass </a> <nav aria-label=SetWindowSubclass class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#refactoring-create_windowexe> Refactoring create_window.exe </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#refactoring-hellodll> Refactoring hello.dll </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#hello_inject> hello_inject </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#further-reading_1> Further Reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#debugging> Debugging </a> <nav aria-label=Debugging class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#logging> Logging </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#tracing> Tracing </a> <nav aria-label=Tracing class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#process-monitor> Process Monitor </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowsubclass-cont> SetWindowSubclass (cont.) </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setwindowshookex> SetWindowsHookEx </a> <nav aria-label=SetWindowsHookEx class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#further-reading_2> Further Reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#createthread> CreateThread </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#production-readiness> Production Readiness </a> <nav aria-label="Production Readiness" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#error-handling> Error Handling </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a class=md-tag href=../../tags/index.html#rust>rust</a> <a class=md-tag href=../../tags/index.html#dll>dll</a> <a class=md-tag href=../../tags/index.html#howto>howto</a> <a class=md-tag href=../../tags/index.html#windows>windows</a> <a class=md-tag href=../../tags/index.html#programming>programming</a> </nav> <h1 id=production-ready-dll-injection>Production Ready DLL Injection<a class=headerlink href=#production-ready-dll-injection title="Permanent link">¶</a></h1> <p>Dear reader, if you haven't, already, please catch up on <a href=../creating-a-dll-with-rust/index.html>Part 1</a>, <a href=../creating-a-window-with-rust/index.html>Part 2</a>, and <a href=../injecting-dlls-with-rust/index.html>Part 3</a> and come back here. It'll be worth it. </p> <p>Everyone else, here's what we've covered:</p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input checked disabled type=checkbox><span class=task-list-indicator></span></label> Create a Windows dynamic-link library (DLL) using Rust</li> <li class=task-list-item><label class=task-list-control><input checked disabled type=checkbox><span class=task-list-indicator></span></label> Inject DLLs into processes using Process Hacker</li> <li class=task-list-item><label class=task-list-control><input checked disabled type=checkbox><span class=task-list-indicator></span></label> Inject DLLs into processes using Rust</li> <li class=task-list-item><label class=task-list-control><input checked disabled type=checkbox><span class=task-list-indicator></span></label> Create application windows using Rust</li> <li class=task-list-item><label class=task-list-control><input checked disabled type=checkbox><span class=task-list-indicator></span></label> Override a window's behavior using subclassing</li> </ul> <p>In today's episode, we'll focus on making our DLL "production-ready", by <a href=https://en.wikipedia.org/wiki/RTFM>RTFM</a>'ing, adding logging, improving error handling, and, oh yeah, re-writing the whole thing. </p> <h2 id=read-the-fscking-manual>Read The Fscking Manual<a class=headerlink href=#read-the-fscking-manual title="Permanent link">¶</a></h2> <p>As a believer in <a href=https://www.instructionaldesign.org/theories/minimalism/ >Minimalist Instruction </a>, I've focused on getting your hands dirty as quickly as possible.</p> <p>However, DLL injection <em>and</em> window subclassing are extraordinarily powerful and invasive tools, which <em>both</em> transcend traditional operating systems process boundaries; boundaries specifically created to protect running applications from poorly written and/or malicious code.</p> <p>Implementing these sorts of things relying solely on a tutorial, <em>without</em>, studying the underlying system documentation, is a mistake.</p> <p>To see what I mean, let's read some fscking manuals, starting with, <code>SetWindowLongPtr()</code>.</p> <h3 id=setwindowlongptr>SetWindowLongPtr<a class=headerlink href=#setwindowlongptr title="Permanent link">¶</a></h3> <p>I was serious, go ahead and read it: <a href=https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowlongptra>here</a></p> <p>It starts with an easy one:</p> <blockquote> <p>The SetWindowLongPtr function fails if the process that owns the window specified by the hWnd parameter is at a higher process privilege in the UIPI hierarchy than the process the calling thread resides in.</p> </blockquote> <p>Basically, we can't subclass apps running as "Administrator" if we're a normal user. This isn't surprising, but can we proactively check and/or inform the user of workarounds?</p> <blockquote> <p>Windows XP/2000: The SetWindowLongPtr function fails if the window specified by the hWnd parameter does not belong to the same process as the calling thread.</p> </blockquote> <p>This shouldn't be an issue, but good to know if we get a support email.</p> <blockquote> <p>If you use SetWindowLongPtr with the GWLP_WNDPROC index to replace the window procedure, the window procedure must conform to the guidelines specified in the description of the WindowProc callback function.</p> </blockquote> <p>Good, we covered this in <a href=../creating-a-window-with-rust/index.html#callback-function>Creating A Window With RustCallback Function</a>.</p> <blockquote> <p>Calling SetWindowLongPtr with the GWLP_WNDPROC index creates a subclass of the window class used to create the window. </p> </blockquote> <p>Perfect, that's what we did.</p> <blockquote> <p>An application can subclass a system class, but should not subclass a window class created by another process. </p> </blockquote> <p>lol.</p> <blockquote> <p>The SetWindowLongPtr function creates the window subclass by changing the window procedure associated with a particular window class, causing the system to call the new window procedure instead of the previous one. </p> </blockquote> <p>Sketching this out, we have a Window with a default window procedure:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-21.46.24.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 21.46.24.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-21.46.24.excalidraw.svg></a></p> <p>After a <code>SetWindowLongPtr()</code>, the <strong>default</strong> window procedure is replaced with our <strong>new</strong> window procedure's address.</p> <p>The <strong>new</strong> window procedure calls <code>DefWindowProcW()</code>to hand-off unprocessed messages to the <strong>default</strong> window procedure:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.06.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 22.17.06.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.06.excalidraw.svg></a></p> <p>Makes sense.</p> <blockquote> <p>An application must pass any messages not processed by the new window procedure to the previous window procedure by calling CallWindowProc. This allows the application to create a chain of window procedures.</p> </blockquote> <p>Parsing this out <em>fully</em>:</p> <ul> <li>if we don't process the message, then we <em>must</em> hand-off to previous window procedure</li> <li>if we <em>do</em> process a message, we can <em>choose</em> whether to return or to hand it off</li> </ul> <p>Got it.</p> <hr> <p><a href=https://learn.microsoft.com/en-us/windows/win32/winmsg/about-window-procedures#instance-subclassing>About Window Procedures</a> mentions:</p> <blockquote> <p>The application must also have the original window procedure address to remove the subclass from the window. To remove the subclass, the application calls SetWindowLong again, passing the address of the original window procedure with the GWL_WNDPROC flag and the handle to the window.</p> </blockquote> <p>Removing a subclass using <code>prev_wndproc</code> is straightforward. We just need to make sure we hold onto it.</p> <blockquote> <p>When an application subclasses a subclassed window, it must remove the subclasses in the reverse order they were performed. If the removal order is not reversed, an unrecoverable system error may occur.</p> </blockquote> <p>Considering the case where we subclass a window twice, for whatever reason, we need to unsubclass in the reverse order:</p> <div class="language-rust highlight"><pre><span></span><code><span id=__span-0-1><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a>#<span class=w> </span><span class=n>Subclassing</span>
</span><span id=__span-0-2><a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a><span class=kd>let</span><span class=w> </span><span class=n>one</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SetWindowLongPtr</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=o>..</span><span class=p>.)</span>
</span><span id=__span-0-3><a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a><span class=kd>let</span><span class=w> </span><span class=n>two</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SetWindowLongPtr</span><span class=p>(</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=o>..</span><span class=p>.)</span>
</span><span id=__span-0-4><a href=#__codelineno-0-4 id=__codelineno-0-4 name=__codelineno-0-4></a>
</span><span id=__span-0-5><a href=#__codelineno-0-5 id=__codelineno-0-5 name=__codelineno-0-5></a>#<span class=w> </span><span class=n>Unsubclassing</span>
</span><span id=__span-0-6><a href=#__codelineno-0-6 id=__codelineno-0-6 name=__codelineno-0-6></a><span class=n>SetWindowLongPtr</span><span class=p>(</span><span class=n>two</span><span class=p>,</span><span class=w> </span><span class=o>..</span><span class=p>.);</span><span class=w> </span><span class=c1>// returns b</span>
</span><span id=__span-0-7><a href=#__codelineno-0-7 id=__codelineno-0-7 name=__codelineno-0-7></a><span class=n>SetWindowLongPtr</span><span class=p>(</span><span class=n>one</span><span class=p>,</span><span class=w> </span><span class=o>..</span><span class=p>.);</span><span class=w> </span><span class=c1>// returns a</span>
</span></code></pre></div> <p>👍</p> <hr> <p>In <a href="https://devblogs.microsoft.com/oldnewthing/20031110-00/?p=41893">Homework assignment about window subclassing</a> and <a href="https://devblogs.microsoft.com/oldnewthing/20031111-00/?p=41883"> Safer subclassing</a> warns:</p> <blockquote> <p>One gotcha that isn’t explained clearly in the documentation is that <strong>you must remove your window subclass before the window being subclassed is destroyed</strong>. This is typically done either by removing the subclass once your temporary need has passed, or if you are installing a permanent subclass, by inserting a call to RemoveWindowSubclass inside the subclass procedure itself: </p> </blockquote> <div class="language-c++ highlight"><pre><span></span><code><span id=__span-1-1><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=p>...</span>
</span><span id=__span-1-2><a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a><span class=k>case</span><span class=w> </span><span class=no>WM_NCDESTROY</span><span class=p>:</span>
</span><span id=__span-1-3><a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a><span class=w>  </span><span class=n>RemoveWindowSubclass</span><span class=p>(</span><span class=n>hwnd</span><span class=p>,</span><span class=w> </span><span class=n>thisfunctionname</span><span class=p>,</span><span class=w> </span><span class=n>uIdSubclass</span><span class=p>);</span>
</span><span id=__span-1-4><a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>DefSubclassProc</span><span class=p>(...);</span>
</span></code></pre></div> <p>So, if the user unexpectedly closes a window that we've subclassed, <em>we</em> <strong>must</strong> remove our subclass when we receive the <code>WM_NCDESTROY</code> message <em>(which is actually the very last message the system sends us before terminating the window)</em>.</p> <blockquote> <p>Do not assume that subclasses are added and removed in a purely stack-like manner. <strong>If you want to unsubclass and find that you are not the window procedure at the top of the chain you cannot safely unsubclass. You will have to leave your subclass attached until it becomes safe to unsubclass.</strong> Until that time, you just have to keep passing the messages through to the previous procedure. </p> </blockquote> <p>So, when removing a subclass (by calling <code>SetWindowLongPtr</code> with <code>prev_wndproc</code>), we have to somehow determine if anyone has subclassed the same window <em>after</em> us, and if so, wait until <code>WM_NCDESTROY</code> to remove our subclass.</p> <p>This one's a doozy, so let's sketch it out, starting with out default window procedure:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-21.46.24.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 21.46.24.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-21.46.24.excalidraw.svg></a></p> <hr> <p>After a <code>SetWindowLongPtr()</code>, the <strong>default</strong> window procedure is replaced with our <strong>new</strong> window procedure's address:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.06.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 22.17.06.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.06.excalidraw.svg></a></p> <hr> <p>At some point before <em>we</em> unsubclass ourselves, <strong><em>someone else</em></strong> calls <code>SetWindowLongPtr()</code> and replaces <em>our</em> window procedure, with <em>theirs</em>. </p> <p>Of course, they think <em>our</em> window procedure is the <strong>default</strong> window procedure, so they squirrel it away for safe keeping.</p> <p>Hopefully, they're handing-off unprocessed messages using <code>DefWindowProcW()</code>, in which case, <em>our</em> window procedure receives those messages:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.15.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 22.17.15.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.15.excalidraw.svg></a></p> <hr> <p>Then, if <em>we</em> decide to unsubclass <em>before</em> <strong>they</strong> unsubclass, by calling <code>SetWindowLongPtr()</code> with <em>our</em> <code>prev_wndproc</code>, we end up accidentally unsubclassing <em>them</em> as well:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.37.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 22.17.37.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.37.excalidraw.svg></a></p> <p>Oy vey.</p> <hr> <p>So, it's actually easy to check if someone's subclassed <em>after</em> us by calling <code>GetWindowLongPtr()</code>, and comparing what's returned against <code>prev_wndproc</code>. </p> <p>But that's rife with race conditions, and probably (definitely) requires locks and mutexes and 🤮</p> <p><em>And</em>, even if we get that sorted, how do we get <code>0xCCC</code> to call <code>0xAAA</code>, instead of our removed subclass procedure?</p> <p>Yeah, Raymond's basically saying that we're <em>trapped</em> until <code>WM_NCDESTROY</code> if someone subclasses after us...</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.54.excalidraw.svg><img alt="Production Ready DLL Injection 2023-03-09 22.17.54.excalidraw.svg" src=../../assets/images/production-ready-dll-injection-2023-03-09-22.17.54.excalidraw.svg></a></p> <h3 id=conclusions>Conclusions<a class=headerlink href=#conclusions title="Permanent link">¶</a></h3> <p>After wading through all that <code>SetWindowLongPtr</code> documentation and errata, it feels like we've hit some really insurmountable issues; unless we're ok with leaving DLLs dangling around, potentially forever, if we get subclassed.</p> <p>Fortunately, Raymond gives us a glimmer of hope, <a href=https://learn.microsoft.com/en-us/windows/win32/api/commctrl/nf-commctrl-setwindowsubclass>SetWindowSubclass</a>, which we'll explore next.</p> <h3 id=further-reading>Further reading<a class=headerlink href=#further-reading title="Permanent link">¶</a></h3> <ul> <li><a href="https://devblogs.microsoft.com/oldnewthing/20050726-00/?p=34803">What is the difference between WM_DESTROY and WM_NCDESTROY?</a></li> </ul> <hr> <h2 id=setwindowsubclass>SetWindowSubclass<a class=headerlink href=#setwindowsubclass title="Permanent link">¶</a></h2> <p>Let's start by reading the documentation: <a href=https://learn.microsoft.com/en-us/windows/win32/api/commctrl/nf-commctrl-setwindowsubclass>here</a></p> <p>Everything seems great until we get to <a href=https://learn.microsoft.com/en-us/windows/win32/api/commctrl/nf-commctrl-setwindowsubclass#remarks>this</a> warning:</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>You cannot use the subclassing helper functions to subclass a window across threads.</p> </div> <p>From our earlier <code>SetWindowLongPtr</code> experiments, we saw that DllMain is called from the same <em>process</em> but a different <em>thread</em> than the main GUI thread.</p> <p>If we want to use SetWindowSubclass, we'll have to work around this.</p> <p>Let's get our hands dirty by refactoring <code>create_window</code> to use <code>SetWindowSubclass</code> instead of <code>SetWindowLongPtr</code>.</p> <h4 id=refactoring-create_windowexe>Refactoring create_window.exe<a class=headerlink href=#refactoring-create_windowexe title="Permanent link">¶</a></h4> <p>First, replace the existing calls with:</p> <div class="language-rust highlight"><pre><span></span><code><span id=__span-2-1><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a><span class=c1>//LoadLibraryA(PCSTR("hello.dll\0".as_ptr()));</span>
</span><span id=__span-2-2><a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a><span class=c1>//let result = SetWindowLongPtrW(handle, GWLP_WNDPROC, wnd_proc as isize);</span>
</span><span id=__span-2-3><a href=#__codelineno-2-3 id=__codelineno-2-3 name=__codelineno-2-3></a><span class=c1>//PREV_WNDPROC = transmute::&lt;isize, WNDPROC&gt;(result);</span>
</span><span id=__span-2-4><a href=#__codelineno-2-4 id=__codelineno-2-4 name=__codelineno-2-4></a>
</span><span id=__span-2-5><a href=#__codelineno-2-5 id=__codelineno-2-5 name=__codelineno-2-5></a><span class=n>SetWindowSubclass</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>wnd_proc</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span></code></pre></div> <p>Copy over <code>wnd_proc</code> from <code>lib.rs</code>:</p> <div class="language-rust highlight"><span class=filename>lib.rs</span><pre><span></span><code><span id=__span-3-1><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=k>extern</span><span class=w> </span><span class=s>"system"</span><span class=w> </span><span class=k>fn</span> <span class=nf>wnd_proc</span><span class=p>(</span>
</span><span id=__span-3-2><a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a><span class=w>    </span><span class=n>window</span>: <span class=nc>HWND</span><span class=p>,</span>
</span><span id=__span-3-3><a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a><span class=w>    </span><span class=n>message</span>: <span class=kt>u32</span><span class=p>,</span>
</span><span id=__span-3-4><a href=#__codelineno-3-4 id=__codelineno-3-4 name=__codelineno-3-4></a><span class=w>    </span><span class=n>wparam</span>: <span class=nc>WPARAM</span><span class=p>,</span>
</span><span id=__span-3-5><a href=#__codelineno-3-5 id=__codelineno-3-5 name=__codelineno-3-5></a><span class=w>    </span><span class=n>lparam</span>: <span class=nc>LPARAM</span><span class=p>,</span>
</span><span id=__span-3-6><a href=#__codelineno-3-6 id=__codelineno-3-6 name=__codelineno-3-6></a><span class=hll><span class=w>    </span><span class=n>_</span>: <span class=kt>usize</span><span class=p>,</span>
</span></span><span id=__span-3-7><a href=#__codelineno-3-7 id=__codelineno-3-7 name=__codelineno-3-7></a><span class=hll><span class=w>    </span><span class=n>_</span>: <span class=kt>usize</span><span class=p>,</span>
</span></span><span id=__span-3-8><a href=#__codelineno-3-8 id=__codelineno-3-8 name=__codelineno-3-8></a><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>LRESULT</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-9><a href=#__codelineno-3-9 id=__codelineno-3-9 name=__codelineno-3-9></a><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-10><a href=#__codelineno-3-10 id=__codelineno-3-10 name=__codelineno-3-10></a><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-11><a href=#__codelineno-3-11 id=__codelineno-3-11 name=__codelineno-3-11></a><span class=w>            </span><span class=n>WM_PAINT</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-12><a href=#__codelineno-3-12 id=__codelineno-3-12 name=__codelineno-3-12></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w>  </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=s>"ZOMG!"</span><span class=p>);</span>
</span><span id=__span-3-13><a href=#__codelineno-3-13 id=__codelineno-3-13 name=__codelineno-3-13></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>ps</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PAINTSTRUCT</span>::<span class=n>default</span><span class=p>();</span>
</span><span id=__span-3-14><a href=#__codelineno-3-14 id=__codelineno-3-14 name=__codelineno-3-14></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>psp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>ps</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>PAINTSTRUCT</span><span class=p>;</span>
</span><span id=__span-3-15><a href=#__codelineno-3-15 id=__codelineno-3-15 name=__codelineno-3-15></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rectp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>ps</span><span class=p>.</span><span class=n>rcPaint</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>RECT</span><span class=p>;</span>
</span><span id=__span-3-16><a href=#__codelineno-3-16 id=__codelineno-3-16 name=__codelineno-3-16></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>hdc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BeginPaint</span><span class=p>(</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>psp</span><span class=p>);</span>
</span><span id=__span-3-17><a href=#__codelineno-3-17 id=__codelineno-3-17 name=__codelineno-3-17></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>brush</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CreateSolidBrush</span><span class=p>(</span><span class=n>COLORREF</span><span class=p>(</span><span class=mh>0x0000F0F0</span><span class=p>));</span>
</span><span id=__span-3-18><a href=#__codelineno-3-18 id=__codelineno-3-18 name=__codelineno-3-18></a><span class=w>                </span><span class=n>FillRect</span><span class=p>(</span><span class=n>hdc</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ps</span><span class=p>.</span><span class=n>rcPaint</span><span class=p>,</span><span class=w> </span><span class=n>brush</span><span class=p>);</span>
</span><span id=__span-3-19><a href=#__codelineno-3-19 id=__codelineno-3-19 name=__codelineno-3-19></a><span class=w>                </span><span class=n>DrawTextA</span><span class=p>(</span><span class=n>hdc</span><span class=p>,</span>
</span><span id=__span-3-20><a href=#__codelineno-3-20 id=__codelineno-3-20 name=__codelineno-3-20></a><span class=w>                    </span><span class=n>msg</span><span class=p>.</span><span class=n>as_bytes_mut</span><span class=p>(),</span>
</span><span id=__span-3-21><a href=#__codelineno-3-21 id=__codelineno-3-21 name=__codelineno-3-21></a><span class=w>                    </span><span class=n>rectp</span><span class=p>,</span>
</span><span id=__span-3-22><a href=#__codelineno-3-22 id=__codelineno-3-22 name=__codelineno-3-22></a><span class=w>                    </span><span class=n>DT_SINGLELINE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DT_CENTER</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DT_VCENTER</span>
</span><span id=__span-3-23><a href=#__codelineno-3-23 id=__codelineno-3-23 name=__codelineno-3-23></a><span class=w>                </span><span class=p>);</span>
</span><span id=__span-3-24><a href=#__codelineno-3-24 id=__codelineno-3-24 name=__codelineno-3-24></a><span class=w>                </span><span class=n>EndPaint</span><span class=p>(</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ps</span><span class=p>);</span>
</span><span id=__span-3-25><a href=#__codelineno-3-25 id=__codelineno-3-25 name=__codelineno-3-25></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>LRESULT</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-3-26><a href=#__codelineno-3-26 id=__codelineno-3-26 name=__codelineno-3-26></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-3-27><a href=#__codelineno-3-27 id=__codelineno-3-27 name=__codelineno-3-27></a><span class=w>            </span><span class=n>WM_WINDOWPOSCHANGING</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-28><a href=#__codelineno-3-28 id=__codelineno-3-28 name=__codelineno-3-28></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lparam</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>WINDOWPOS</span><span class=p>;</span>
</span><span id=__span-3-29><a href=#__codelineno-3-29 id=__codelineno-3-29 name=__codelineno-3-29></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
</span><span id=__span-3-30><a href=#__codelineno-3-30 id=__codelineno-3-30 name=__codelineno-3-30></a><span class=w>                </span><span class=n>data</span><span class=p>.</span><span class=n>flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>SWP_NOSIZE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>SWP_NOMOVE</span><span class=p>;</span>
</span><span id=__span-3-31><a href=#__codelineno-3-31 id=__codelineno-3-31 name=__codelineno-3-31></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>LRESULT</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-3-32><a href=#__codelineno-3-32 id=__codelineno-3-32 name=__codelineno-3-32></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-3-33><a href=#__codelineno-3-33 id=__codelineno-3-33 name=__codelineno-3-33></a><span class=w>            </span><span class=n>WM_NCDESTROY</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-34><a href=#__codelineno-3-34 id=__codelineno-3-34 name=__codelineno-3-34></a><span class=w>                </span><span class=c1>// let result = transmute::&lt;WNDPROC, _&gt;(PREV_WNDPROC);</span>
</span><span id=__span-3-35><a href=#__codelineno-3-35 id=__codelineno-3-35 name=__codelineno-3-35></a><span class=w>                </span><span class=c1>// SetWindowLongPtrW(window, GWLP_WNDPROC, result);</span>
</span><span id=__span-3-36><a href=#__codelineno-3-36 id=__codelineno-3-36 name=__codelineno-3-36></a><span class=hll><span class=w>                </span><span class=n>RemoveWindowSubclass</span><span class=p>(</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>wnd_proc</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span></span><span id=__span-3-37><a href=#__codelineno-3-37 id=__codelineno-3-37 name=__codelineno-3-37></a><span class=hll><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>DefWindowProcA</span><span class=p>(</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>wparam</span><span class=p>,</span><span class=w> </span><span class=n>lparam</span><span class=p>);</span>
</span></span><span id=__span-3-38><a href=#__codelineno-3-38 id=__codelineno-3-38 name=__codelineno-3-38></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-3-39><a href=#__codelineno-3-39 id=__codelineno-3-39 name=__codelineno-3-39></a><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>()</span>
</span><span id=__span-3-40><a href=#__codelineno-3-40 id=__codelineno-3-40 name=__codelineno-3-40></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-41><a href=#__codelineno-3-41 id=__codelineno-3-41 name=__codelineno-3-41></a><span class=w>        </span><span class=c1>// CallWindowProcW(PREV_WNDPROC, window, message, wparam, lparam)</span>
</span><span id=__span-3-42><a href=#__codelineno-3-42 id=__codelineno-3-42 name=__codelineno-3-42></a><span class=hll><span class=w>        </span><span class=n>DefSubclassProc</span><span class=p>(</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>wparam</span><span class=p>,</span><span class=w> </span><span class=n>lparam</span><span class=p>)</span>
</span></span><span id=__span-3-43><a href=#__codelineno-3-43 id=__codelineno-3-43 name=__codelineno-3-43></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-44><a href=#__codelineno-3-44 id=__codelineno-3-44 name=__codelineno-3-44></a><span class=p>}</span>
</span></code></pre></div> <p>Doing a <code>cargo run --bin create_window</code> should have a few unused import warnings, but yield a:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/pasted-image-20230309102433.png><img alt="Pasted image 20230309102433.png" src=../../assets/images/pasted-image-20230309102433.png></a></p> <p>Well, that was pretty easy!</p> <p>Now let's do the same with <code>lib.rs</code>:</p> <h4 id=refactoring-hellodll>Refactoring hello.dll<a class=headerlink href=#refactoring-hellodll title="Permanent link">¶</a></h4> <p>Do stuff...</p> <p><code>cargo run --bin create_window</code> results in:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/pasted-image-20230309102433.png><img alt="Pasted image 20230309102433.png" src=../../assets/images/pasted-image-20230309102433.png></a></p> <p>Yay!</p> <h4 id=hello_inject>hello_inject<a class=headerlink href=#hello_inject title="Permanent link">¶</a></h4> <p><code>cargo run --bin hello_inject</code> doesn't work. Why?</p> <p>To understand, let's talk about Debugging.</p> <h3 id=further-reading_1>Further Reading<a class=headerlink href=#further-reading_1 title="Permanent link">¶</a></h3> <ul> <li><a href=https://learn.microsoft.com/en-us/windows/win32/api/commctrl/nf-commctrl-setwindowsubclass>SetWindowSubclass</a></li> <li><a href="https://learn.microsoft.com/en-us/windows/win32/controls/subclassing-overview?source=recommendations">Subclassing Controls</a></li> <li><a href=https://learn.microsoft.com/en-us/windows/win32/winmsg/about-window-procedures#window-procedure-subclassing>Window Procedure Subclassing</a></li> </ul> <h2 id=debugging>Debugging<a class=headerlink href=#debugging title="Permanent link">¶</a></h2> <p>Debugging DLLs in any language isn't amazing. Debugging DLLs in Rust is... rudimentary. Let's explore our options, starting with, logging!</p> <h3 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">¶</a></h3> <p>Up until know we've been able to eyeball success vs failure as we're doing stuff with visible side effects.</p> <p>Now that we've reached the part where... we're going to need to log.</p> <p>Luckily, the <code>simple-logger</code> crate offers drop-dead simple logging. Add it to the <code>hello.dll</code> crate with a:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-4-1><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a>cargo<span class=w> </span>add<span class=w> </span>log<span class=w> </span>simple-logger<span class=w> </span>--package<span class=w> </span>hello
</span></code></pre></div> <p>And add this to <code>lib.rs</code>:</p> <div class="language-rust highlight"><span class=filename>hello\src\lib.rs</span><pre><span></span><code><span id=__span-5-1><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=k>use</span><span class=w> </span><span class=n>log</span>::<span class=p>{</span><span class=n>LevelFilter</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>};</span>
</span><span id=__span-5-2><a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a>
</span><span id=__span-5-3><a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a><span class=k>fn</span> <span class=nf>attach</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-4><a href=#__codelineno-5-4 id=__codelineno-5-4 name=__codelineno-5-4></a><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-5><a href=#__codelineno-5-5 id=__codelineno-5-5 name=__codelineno-5-5></a><span class=w>        </span><span class=n>simple_logging</span>::<span class=n>log_to_file</span><span class=p>(</span><span class=s>"C:</span><span class=se>\\</span><span class=s>temp</span><span class=se>\\</span><span class=s>hello.dll.log"</span><span class=p>,</span><span class=w> </span><span class=n>LevelFilter</span>::<span class=n>Info</span><span class=p>);</span>
</span><span id=__span-5-6><a href=#__codelineno-5-6 id=__codelineno-5-6 name=__codelineno-5-6></a>
</span><span id=__span-5-7><a href=#__codelineno-5-7 id=__codelineno-5-7 name=__codelineno-5-7></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>find_window_by_pid</span><span class=p>(</span><span class=n>GetCurrentProcessId</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span>
</span><span id=__span-5-8><a href=#__codelineno-5-8 id=__codelineno-5-8 name=__codelineno-5-8></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SetWindowLongPtrW</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=n>GWLP_WNDPROC</span><span class=p>,</span><span class=w> </span><span class=n>wnd_proc</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>isize</span><span class=p>);</span>
</span><span id=__span-5-9><a href=#__codelineno-5-9 id=__codelineno-5-9 name=__codelineno-5-9></a><span class=w>        </span><span class=n>PREV_WNDPROC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transmute</span>::<span class=o>&lt;</span><span class=kt>isize</span><span class=p>,</span><span class=w> </span><span class=n>WNDPROC</span><span class=o>&gt;</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span><span id=__span-5-10><a href=#__codelineno-5-10 id=__codelineno-5-10 name=__codelineno-5-10></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-5-11><a href=#__codelineno-5-11 id=__codelineno-5-11 name=__codelineno-5-11></a><span class=p>}</span>
</span></code></pre></div> <h3 id=tracing>Tracing<a class=headerlink href=#tracing title="Permanent link">¶</a></h3> <h4 id=process-monitor>Process Monitor<a class=headerlink href=#process-monitor title="Permanent link">¶</a></h4> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../assets/images/pasted-image-20230309112332.png><img alt="Pasted image 20230309112332.png" src=../../assets/images/pasted-image-20230309112332.png></a></p> <hr> <h2 id=setwindowsubclass-cont>SetWindowSubclass (cont.)<a class=headerlink href=#setwindowsubclass-cont title="Permanent link">¶</a></h2> <p>Now that we're certain that <code>SetWindowSubclass</code> is not going to work across threads... we need to figure out how to call <code>SetWindowSubclass</code> from our window's GUI thread.</p> <p>Enter this nugget from Raymond Chen:</p> <blockquote> <p>Recall that when an event occurs on a thread, the window hook is called from the same thread that the event occurred on. For example, a WH_CALL­WND­PROC hook procedure is called when a window procedure is about to be called, and the call occurs on the thread that is about to call the window procedure. ... Anyway, if you have a window hook that can be installed per-thread, then it will be installed only for events on that thread. In the above example, it means that only window procedures on that thread will trigger the hook. - source: <a href="https://devblogs.microsoft.com/oldnewthing/20180926-00/?p=99825">What does the thread parameter to Set­Windows­Hook­Ex actually mean?</a></p> </blockquote> <hr> <h2 id=setwindowshookex>SetWindowsHookEx<a class=headerlink href=#setwindowshookex title="Permanent link">¶</a></h2> <p>Let's start by reading <a href=https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa>SetWindowHookEx</a>.</p> <p>Great, now let's start refactoring <code>hello.dll</code>, starting with <code>attach()</code>:</p> <div class="language-rust highlight"><span class=filename>hello\src\lib.rs</span><pre><span></span><code><span id=__span-6-1><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a><span class=kd>let</span><span class=w> </span><span class=n>gui_tid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GetWindowThreadProcessId</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=nb>None</span><span class=p>);</span>
</span><span id=__span-6-2><a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a>
</span><span id=__span-6-3><a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a><span class=kd>let</span><span class=w> </span><span class=n>hook</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SetWindowsHookExA</span><span class=p>(</span>
</span><span id=__span-6-4><a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a><span class=w>    </span><span class=n>WH_CALLWNDPROC</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-6-5><a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>call_wnd_proc</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-6-6><a href=#__codelineno-6-6 id=__codelineno-6-6 name=__codelineno-6-6></a><span class=w>    </span><span class=nb>None</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-6-7><a href=#__codelineno-6-7 id=__codelineno-6-7 name=__codelineno-6-7></a><span class=w>    </span><span class=n>gui_tid</span><span class=w> </span>
</span><span id=__span-6-8><a href=#__codelineno-6-8 id=__codelineno-6-8 name=__codelineno-6-8></a><span class=p>);</span>
</span></code></pre></div> <p>Now let's add <code>call_wnd_proc</code> below <code>attach</code>:</p> <div class="language-rust highlight"><span class=filename>hello\src\lib.rs</span><pre><span></span><code><span id=__span-7-1><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a><span class=cp>#[no_mangle]</span>
</span><span id=__span-7-2><a href=#__codelineno-7-2 id=__codelineno-7-2 name=__codelineno-7-2></a><span class=k>unsafe</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>"system"</span><span class=w> </span>
</span><span id=__span-7-3><a href=#__codelineno-7-3 id=__codelineno-7-3 name=__codelineno-7-3></a><span class=k>fn</span> <span class=nf>call_wnd_proc</span><span class=p>(</span><span class=n>n_code</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>w_param</span>: <span class=nc>WPARAM</span><span class=p>,</span><span class=w> </span><span class=n>l_param</span>: <span class=nc>LPARAM</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>LRESULT</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-4><a href=#__codelineno-7-4 id=__codelineno-7-4 name=__codelineno-7-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>HC_ACTION</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i32</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>n_code</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-5><a href=#__codelineno-7-5 id=__codelineno-7-5 name=__codelineno-7-5></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>origin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>w_param</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u32</span><span class=p>;</span>
</span><span id=__span-7-6><a href=#__codelineno-7-6 id=__codelineno-7-6 name=__codelineno-7-6></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>param</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=n>l_param</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>CWPSTRUCT</span><span class=p>)</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-7-7><a href=#__codelineno-7-7 id=__codelineno-7-7 name=__codelineno-7-7></a>
</span><span id=__span-7-8><a href=#__codelineno-7-8 id=__codelineno-7-8 name=__codelineno-7-8></a><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>param</span><span class=p>.</span><span class=n>message</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-9><a href=#__codelineno-7-9 id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>            </span><span class=n>WM_SIZING</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>info</span><span class=o>!</span><span class=p>(</span><span class=s>"CallWndProc: Received WM_SIZING"</span><span class=p>),</span>
</span><span id=__span-7-10><a href=#__codelineno-7-10 id=__codelineno-7-10 name=__codelineno-7-10></a><span class=w>            </span><span class=n>WM_PAINT</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-11><a href=#__codelineno-7-11 id=__codelineno-7-11 name=__codelineno-7-11></a><span class=w>                </span><span class=n>info</span><span class=o>!</span><span class=p>(</span><span class=s>"CallWndProc: Received WM_PAINT"</span><span class=p>);</span>
</span><span id=__span-7-12><a href=#__codelineno-7-12 id=__codelineno-7-12 name=__codelineno-7-12></a><span class=w>                </span><span class=n>SetWindowSubclass</span><span class=p>(</span><span class=n>param</span><span class=p>.</span><span class=n>hwnd</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-7-13><a href=#__codelineno-7-13 id=__codelineno-7-13 name=__codelineno-7-13></a><span class=w>                    </span><span class=nb>Some</span><span class=p>(</span><span class=n>wnd_proc</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-7-14><a href=#__codelineno-7-14 id=__codelineno-7-14 name=__codelineno-7-14></a><span class=w>                    </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-7-15><a href=#__codelineno-7-15 id=__codelineno-7-15 name=__codelineno-7-15></a><span class=w>                    </span><span class=n>GUI_TID</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>_</span>
</span><span id=__span-7-16><a href=#__codelineno-7-16 id=__codelineno-7-16 name=__codelineno-7-16></a><span class=w>                </span><span class=p>);</span>
</span><span id=__span-7-17><a href=#__codelineno-7-17 id=__codelineno-7-17 name=__codelineno-7-17></a><span class=w>            </span><span class=p>},</span>
</span><span id=__span-7-18><a href=#__codelineno-7-18 id=__codelineno-7-18 name=__codelineno-7-18></a>
</span><span id=__span-7-19><a href=#__codelineno-7-19 id=__codelineno-7-19 name=__codelineno-7-19></a><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>()</span>
</span><span id=__span-7-20><a href=#__codelineno-7-20 id=__codelineno-7-20 name=__codelineno-7-20></a><span class=w>        </span><span class=p>};</span>
</span><span id=__span-7-21><a href=#__codelineno-7-21 id=__codelineno-7-21 name=__codelineno-7-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-22><a href=#__codelineno-7-22 id=__codelineno-7-22 name=__codelineno-7-22></a>
</span><span id=__span-7-23><a href=#__codelineno-7-23 id=__codelineno-7-23 name=__codelineno-7-23></a><span class=w>    </span><span class=n>CallNextHookEx</span><span class=p>(</span><span class=n>HHOOK</span>::<span class=n>default</span><span class=p>(),</span><span class=w> </span><span class=n>n_code</span><span class=p>,</span><span class=w> </span><span class=n>w_param</span><span class=p>,</span><span class=w> </span><span class=n>l_param</span><span class=p>)</span>
</span><span id=__span-7-24><a href=#__codelineno-7-24 id=__codelineno-7-24 name=__codelineno-7-24></a><span class=p>}</span>
</span></code></pre></div> <h3 id=further-reading_2>Further Reading<a class=headerlink href=#further-reading_2 title="Permanent link">¶</a></h3> <ul> <li><a href="https://social.msdn.microsoft.com/Forums/en-US/8b541e6d-3e47-4f70-be2f-af71fd275542/dllmain-setwindowshookex-callback-problem-c?forum=vcgeneral">Explains DLL-based Implementation</a></li> <li><a href="https://devblogs.microsoft.com/oldnewthing/20050425-41/?p=35803">What is the HINSTANCE passed to SetWindowsHookEx used for?</a></li> <li><a href="https://devblogs.microsoft.com/oldnewthing/20060811-20/?p=30153">Why does SetWindowsHookEx take an HINSTANCE parameter?</a></li> <li><a href="https://devblogs.microsoft.com/oldnewthing/20060810-06/?p=30173">One way people abused hooks in 16-bit Windows</a></li> </ul> <h2 id=createthread>CreateThread<a class=headerlink href=#createthread title="Permanent link">¶</a></h2> <p>Read <a href=https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread>CreateThread</a>.</p> <blockquote> <p>The ExitProcess, ExitThread, CreateThread, CreateRemoteThread functions, and a process that is starting (as the result of a CreateProcess call) are serialized between each other within a process. Only one of these events can happen in an address space at a time. This means the following restrictions hold:</p> <div class="language-text highlight"><pre><span></span><code>- During process startup and DLL initialization routines, new threads can be created, but they do not begin execution until DLL initialization is done for the process.
- Only one thread in a process can be in a DLL initialization or detach routine at a time.
- ExitProcess does not return until no threads are in their DLL initialization or detach routines.
</code></pre></div> <ul> <li><a href=https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread>source</a></li> </ul> </blockquote> <p>Let's refactor <code>attach()</code> so that it creates a new thread:</p> <div class="language-rust highlight"><span class=filename>hello\src\lib.rs</span><pre><span></span><code><span id=__span-8-1><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a><span class=k>fn</span> <span class=nf>attach</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-2><a href=#__codelineno-8-2 id=__codelineno-8-2 name=__codelineno-8-2></a><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-3><a href=#__codelineno-8-3 id=__codelineno-8-3 name=__codelineno-8-3></a><span class=w>        </span><span class=n>THREAD_HANDLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CreateThread</span><span class=p>(</span>
</span><span id=__span-8-4><a href=#__codelineno-8-4 id=__codelineno-8-4 name=__codelineno-8-4></a><span class=w>            </span><span class=nb>None</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-8-5><a href=#__codelineno-8-5 id=__codelineno-8-5 name=__codelineno-8-5></a><span class=w>            </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-8-6><a href=#__codelineno-8-6 id=__codelineno-8-6 name=__codelineno-8-6></a><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>worker_thread</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-8-7><a href=#__codelineno-8-7 id=__codelineno-8-7 name=__codelineno-8-7></a><span class=w>            </span><span class=nb>None</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-8-8><a href=#__codelineno-8-8 id=__codelineno-8-8 name=__codelineno-8-8></a><span class=w>            </span><span class=n>THREAD_CREATION_FLAGS</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-8-9><a href=#__codelineno-8-9 id=__codelineno-8-9 name=__codelineno-8-9></a><span class=w>            </span><span class=nb>None</span><span class=p>);</span>
</span><span id=__span-8-10><a href=#__codelineno-8-10 id=__codelineno-8-10 name=__codelineno-8-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-11><a href=#__codelineno-8-11 id=__codelineno-8-11 name=__codelineno-8-11></a>
</span><span id=__span-8-12><a href=#__codelineno-8-12 id=__codelineno-8-12 name=__codelineno-8-12></a><span class=w>    </span><span class=n>info</span><span class=o>!</span><span class=p>(</span><span class=s>"Finished hooking!"</span><span class=p>);</span>
</span><span id=__span-8-13><a href=#__codelineno-8-13 id=__codelineno-8-13 name=__codelineno-8-13></a><span class=p>}</span>
</span></code></pre></div> <p>And let's create <code>worker_thread()</code>:</p> <div class="language-rust highlight"><span class=filename>hello\src\lib.rs</span><pre><span></span><code><span id=__span-9-1><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a><span class=k>unsafe</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>"system"</span><span class=w> </span><span class=k>fn</span> <span class=nf>worker_thread</span><span class=p>(</span><span class=n>_data</span>: <span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>std</span>::<span class=n>ffi</span>::<span class=n>c_void</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>u32</span> <span class=p>{</span>
</span><span id=__span-9-2><a href=#__codelineno-9-2 id=__codelineno-9-2 name=__codelineno-9-2></a><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-3><a href=#__codelineno-9-3 id=__codelineno-9-3 name=__codelineno-9-3></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>find_window_by_pid</span><span class=p>(</span><span class=n>GetCurrentProcessId</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span>
</span><span id=__span-9-4><a href=#__codelineno-9-4 id=__codelineno-9-4 name=__codelineno-9-4></a><span class=w>        </span><span class=n>GUI_TID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GetWindowThreadProcessId</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=nb>None</span><span class=p>);</span>
</span><span id=__span-9-5><a href=#__codelineno-9-5 id=__codelineno-9-5 name=__codelineno-9-5></a>
</span><span id=__span-9-6><a href=#__codelineno-9-6 id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>logfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>"C:</span><span class=se>\\</span><span class=s>Users</span><span class=se>\\</span><span class=s>me</span><span class=se>\\</span><span class=s>source</span><span class=se>\\</span><span class=s>blog_qa</span><span class=se>\\</span><span class=s>hello.log"</span><span class=p>);</span>
</span><span id=__span-9-7><a href=#__codelineno-9-7 id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w>        </span><span class=n>simple_logging</span>::<span class=n>log_to_file</span><span class=p>(</span><span class=n>logfile</span><span class=p>,</span><span class=w> </span><span class=n>LevelFilter</span>::<span class=n>Info</span><span class=p>);</span>
</span><span id=__span-9-8><a href=#__codelineno-9-8 id=__codelineno-9-8 name=__codelineno-9-8></a>
</span><span id=__span-9-9><a href=#__codelineno-9-9 id=__codelineno-9-9 name=__codelineno-9-9></a><span class=w>        </span><span class=n>info</span><span class=o>!</span><span class=p>(</span><span class=s>"hello.dll attached - tid: {} / pid: {} / target tid: {}"</span><span class=p>,</span>
</span><span id=__span-9-10><a href=#__codelineno-9-10 id=__codelineno-9-10 name=__codelineno-9-10></a><span class=w>            </span><span class=n>GetCurrentThreadId</span><span class=p>(),</span>
</span><span id=__span-9-11><a href=#__codelineno-9-11 id=__codelineno-9-11 name=__codelineno-9-11></a><span class=w>            </span><span class=n>GetCurrentProcessId</span><span class=p>(),</span>
</span><span id=__span-9-12><a href=#__codelineno-9-12 id=__codelineno-9-12 name=__codelineno-9-12></a><span class=w>            </span><span class=n>GUI_TID</span>
</span><span id=__span-9-13><a href=#__codelineno-9-13 id=__codelineno-9-13 name=__codelineno-9-13></a><span class=w>        </span><span class=p>);</span>
</span><span id=__span-9-14><a href=#__codelineno-9-14 id=__codelineno-9-14 name=__codelineno-9-14></a>
</span><span id=__span-9-15><a href=#__codelineno-9-15 id=__codelineno-9-15 name=__codelineno-9-15></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>hook</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SetWindowsHookExA</span><span class=p>(</span>
</span><span id=__span-9-16><a href=#__codelineno-9-16 id=__codelineno-9-16 name=__codelineno-9-16></a><span class=w>            </span><span class=n>WH_CALLWNDPROC</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-9-17><a href=#__codelineno-9-17 id=__codelineno-9-17 name=__codelineno-9-17></a><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>call_wnd_proc</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-9-18><a href=#__codelineno-9-18 id=__codelineno-9-18 name=__codelineno-9-18></a><span class=w>            </span><span class=nb>None</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-9-19><a href=#__codelineno-9-19 id=__codelineno-9-19 name=__codelineno-9-19></a><span class=w>            </span><span class=n>GUI_TID</span><span class=p>);</span>
</span><span id=__span-9-20><a href=#__codelineno-9-20 id=__codelineno-9-20 name=__codelineno-9-20></a>
</span><span id=__span-9-21><a href=#__codelineno-9-21 id=__codelineno-9-21 name=__codelineno-9-21></a><span class=w>        </span><span class=n>HOOKS</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>hook</span><span class=p>);</span>
</span><span id=__span-9-22><a href=#__codelineno-9-22 id=__codelineno-9-22 name=__codelineno-9-22></a>
</span><span id=__span-9-23><a href=#__codelineno-9-23 id=__codelineno-9-23 name=__codelineno-9-23></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-24><a href=#__codelineno-9-24 id=__codelineno-9-24 name=__codelineno-9-24></a><span class=w>            </span><span class=n>thread</span>::<span class=n>sleep</span><span class=p>(</span><span class=n>time</span>::<span class=n>Duration</span>::<span class=n>from_secs</span><span class=p>(</span><span class=mi>100</span><span class=p>));</span>
</span><span id=__span-9-25><a href=#__codelineno-9-25 id=__codelineno-9-25 name=__codelineno-9-25></a><span class=w>        </span><span class=p>};</span>
</span><span id=__span-9-26><a href=#__codelineno-9-26 id=__codelineno-9-26 name=__codelineno-9-26></a><span class=w>    </span><span class=p>};</span>
</span></code></pre></div> <h2 id=production-readiness>Production Readiness<a class=headerlink href=#production-readiness title="Permanent link">¶</a></h2> <h3 id=error-handling>Error Handling<a class=headerlink href=#error-handling title="Permanent link">¶</a></h3> <p><br></p> <div class=blogging-tags-grid> <a class=blogging-tag href=https://samrambles.com/tags#rust><code>#rust</code></a> <a class=blogging-tag href=https://samrambles.com/tags#dll><code>#dll</code></a> <a class=blogging-tag href=https://samrambles.com/tags#howto><code>#howto</code></a> <a class=blogging-tag href=https://samrambles.com/tags#windows><code>#windows</code></a> <a class=blogging-tag href=https://samrambles.com/tags#programming><code>#programming</code></a> </div> <style>
    .md-typeset .blogging-tags-grid {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
    }

    .md-typeset .blogging-tag {
        color: var(--md-typeset-color);
        background-color: var(--md-typeset-code-color);
    }

    .md-typeset .blogging-tag code {
        border-radius: 5px;
    }
</style> <hr> <div class=md-source-file> <small> Last update: 2023-03-17 </small> </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> <a class="md-top md-icon" data-md-component=top hidden href=#> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Made with ❤️ by Sam. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </div> <div class=md-social> <a class=md-social__link href=https://github.com/peddamat rel=noopener target=_blank title=github.com> <svg viewbox="0 0 480 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg> </a> <a class=md-social__link href=https://twitter.com/peddamat rel=noopener target=_blank title=twitter.com> <svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> </a> <a class=md-social__link href=https://www.instagram.com/speddamat rel=noopener target=_blank title=www.instagram.com> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["header.autohide", "search.share", "search.highlight", "search.suggest", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "navigation.tracking", "navigation.top", "navigation.sections", "navigation.tabs", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.2a6f1dda.min.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": false, "openEffect": "none", "closeEffect": "none", "slideEffect": "none"});})</script></body> </html>